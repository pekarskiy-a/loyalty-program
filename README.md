# Программа лояльности Северный Берег

Проект реализует логику программы лояльности для базы отдыха. В проекте сохраняются транзакции и действия сотрудников.

### release 1.0.0

## В данном релизе реализована логика для клиента:

1. Регистрация в программе лояльности (ПЛ)
2. Получение информации по ПЛ
3. Получение информации о балансе

### Для сотрудника:

1. Регистрация осуществляется SQL скриптом, после подключения к поду идет проверка по роли и если такой сотрудник есть, тогда у него будет меню с полномочиями
   администратора
2. Получение информации о клиенте
3. Изменение баланса клиента (установлен ключ идемпотентности, доки в сервисе)
4. Отметка о не заезде (в случае достижения кол-во по отмене бронь без предоплаты снимается).
   При начислении баллов счетчик обнуляется)

### Для администратора

**Создание сотрудника**

1. Нужно создать сотрудника с использованием SQL запроса
2. После входа в чат добавить **c_tg_user_id** в сотрудника
3. Поменять состояние на **SHOW_MAIN_MENU**

### Прочее:

1. Удалил контроллеры для REST, т.к. не стал реализовывать security и не было запроса для фронта
2. Также имеются некоторые неиспользуемые контроллеры, которы были написан для фронта

### Liquibase

1. Скрипты проливаются автоматически при старте приложения
2. Все изменения в программе лояльности **t_loyalty_program** и **t_loyalty_tier** производятся через lb скрипты, если будет осуществлена реализация обновления
   пользователем, тогда необходимо удалить или заменить **onFail="WARN"** на **onFail="MARK_RAN"**

### Docker

Приложение разворачивается на сервере в контейнере докер через **docker-compose.yml**. <br>
БД разворачивается на сервере **timeweb**
Секреты хранятся в файле **.env**

#### Первый запуск

1. Удалять **docker volume** логов приложения, поскольку из-за него подтягивается старый образ и сборка.
2. **НЕЛЬЗЯ** удалять **volume БД**, это приведет к потере данных вслучае удаления контейнера.
3. На текущий момент есть проблема того, что при первком запуске скрипты отрабатывают раньше DDL Hibernate,
   что приводит к ошибке, поэтому сперва отключаем lb script (можно закоментить).</br>
   **Полезные скрипты**</br>

```bash
   cd loyalty-program # переход к папке
   nano .env  # редактирование файла
   docker-compose down # останавливает и удялет контейнер
   docker image rm loyalty-program-loyalty-bot
   docker images # проверяем все ли images нужные нам удалены
   docker volume ls # посмотреть активные тома
   docker volume rm loyalty-program_loyalty_logs # удалить выбранный том
   docker-compose build --no-cache
   docker-compose up
```

#### Получение логов

```bash
   docker exec -it loyalty-program-bot ls /app/logs
   docker exec -it loyalty-program-bot cat /app/logs/<имя_файла_лога>
   docker exec -it loyalty-program-bot tail -f /app/logs/<имя_файла_лога>
   # Копирование
   docker cp loyalty-program-bot:/app/logs/application-2025-06-03.log /tmp/application-2025-06-03.log # копируем на хост
   scp root@188.225.9.102:/tmp/application-2025-06-03.log ./application-2025-06-03.log # копируем на локальный ПК
```

The authenticity of host '188.225.9.102 (188.225.9.102)' can't be established.
ED25519 key fingerprint is SHA256:1hT+MMa8CA0XR1OfngNGEa8BrvD+jKNqD2dX69mP7KY.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '188.225.9.102' (ED25519) to the list of known hosts.
root@188.225.9.102's password: 
